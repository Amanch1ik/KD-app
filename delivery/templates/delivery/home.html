<!DOCTYPE html>
<html lang="kg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karakol Delivery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://maps.api.2gis.ru/2.0/loader.js?pkg=full"></script>
    <style>
        /* Asosiy ranglar, shrift va animatsiyalar */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root {
            --primary-pink: #ec4899;
            --light-pink: #fce7f3;
            --apple-white: #fcfcfc;
            --dark-gray: #262626;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--apple-white);
            color: var(--dark-gray);
        }
        .container {
            max-width: 1024px;
            margin: auto;
            padding: 1rem;
        }
        .page-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .page-content.active {
            display: block;
        }
        .lang-button.active {
            background-color: var(--primary-pink);
            color: white;
            font-weight: 500;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Asosiy ranglarni Tailwind-ga o'tkazish */
        .bg-primary { background-color: var(--primary-pink); }
        .text-primary { color: var(--primary-pink); }
        .hover-bg-primary:hover { background-color: #d9468e; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <script>
        const appState = {
            apiBaseUrl: 'http://127.0.0.1:8000/',
            token: null,
            currentPage: 'login',
            currentLang: 'kg', // Default to Kyrgyz
            currentCurrency: 'KGS', // Default to Kyrgyz currency
            cart: [],
            cachedData: {
                restaurants: [],
                products: [],
                orders: [],
                profile: null
            },

            translations: {
                'kg': {
                    appName: 'Karakol Delivery', homeTitle: '–ë–∏—Ä —á—ã–∫—ã–ª–¥–∞—Ç—É—É –º–µ–Ω–µ–Ω —ç“£ –¥–∞–∞–º–¥—É—É —Ç–∞–º–∞–∫—Ç–∞—Ä!', homeSubtitle: '–°“Ø–π“Ø–∫—Ç“Ø“Ø —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã“£—ã–∑–¥–∞–Ω —Ç–∞–º–∞–∫–∫–∞ –∑–∞–∫–∞–∑ –±–µ—Ä–∏“£–∏–∑.', viewRestaurants: '–†–µ—Å—Ç–æ—Ä–∞–Ω–¥–∞—Ä–¥—ã –∫”©—Ä“Ø“Ø',
                    restaurantsTitle: '–†–µ—Å—Ç–æ—Ä–∞–Ω–¥–∞—Ä', menuTitle: '–ú–µ–Ω—é', addToCart: '–°–µ–±–µ—Ç–∫–µ –∫–æ—à—É—É', orderPageTitle: '–ë—É–π—Ä—É—Ç–º–∞ –±–µ—Ä“Ø“Ø', orderSummary: '–°–∏–∑–¥–∏–Ω –±—É–π—Ä—É—Ç–º–∞“£—ã–∑:',
                    totalSum: '–ñ–∞–ª–ø—ã —Å—É–º–º–∞:', paymentType: '–¢”©–ª”©–º —Ç“Ø—Ä“Ø:', placeOrder: '–ë—É–π—Ä—É—Ç–º–∞ –±–µ—Ä“Ø“Ø', trackingTitle: '–ë—É–π—Ä—É—Ç–º–∞–Ω—ã –∫”©–∑”©–º”©–ª–¥”©”©',
                    courierStatus: '–ö—É—Ä—å–µ—Ä –∂–æ–ª–¥–æ...', profileTitle: '–ú–µ–Ω–∏–Ω –ø—Ä–æ—Ñ–∏–ª–∏–º', orderHistory: '–ë—É–π—Ä—É—Ç–º–∞–ª–∞—Ä —Ç–∞—Ä–∂—ã–º–∞–ª—ã', restaurant: '–†–µ—Å—Ç–æ—Ä–∞–Ω', courier: '–ö—É—Ä—å–µ—Ä', status: '–°—Ç–∞—Ç—É—Å', backHome: '–ë–∞—à–∫—ã –±–µ—Ç–∫–µ –∫–∞–π—Ç—É—É',
                    emptyCart: '–°–µ–±–µ—Ç –±–æ—à, –∞–¥–µ–≥–µ–Ω–¥–µ —Ç–æ–≤–∞—Ä —Ç–∞–Ω–¥–∞“£—ã–∑!', itemAdded: '—Å–µ–±–µ—Ç–∫–µ –∫–æ—à—É–ª–¥—É',
                    loginTitle: '–ö–æ—à –∫–µ–ª–∏“£–∏–∑!', loginSubtitle: '–ö–∏—Ä“Ø“Ø “Ø—á“Ø–Ω –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä–¥—ã –∫–∏—Ä–≥–∏–∑–∏“£–∏–∑', username: '–ö–æ–ª–¥–æ–Ω—É—É—á—É –∞—Ç—ã', password: '–°—ã—Ä—Å”©–∑', loginButton: '–ö–∏—Ä“Ø“Ø',
                    invalidLogin: '–ö–æ–ª–¥–æ–Ω—É—É—á—É –∞—Ç—ã –∂–µ —Å—ã—Ä—Å”©–∑ —Ç—É—É—Ä–∞ —ç–º–µ—Å!', logout: '–ß—ã–≥—É—É', loading: '–ñ“Ø–∫—Ç”©–ª“Ø“Ø–¥”©...', homeButton: '–ë–∞—à–∫—ã', cartButton: '–°–µ–±–µ—Ç', profileButton: '–ü—Ä–æ—Ñ–∏–ª—å',
                    registerTitle: '–ö–∞—Ç—Ç–∞–ª—É—É', registerButton: '–ö–∞—Ç—Ç–∞–ª—É—É',
                    registrationSuccess: '–°–∏–∑ –∏–π–≥–∏–ª–∏–∫—Ç“Ø“Ø –∫–∞—Ç—Ç–∞–ª–¥—ã“£—ã–∑! –≠–º–∏ –∫–∏—Ä–µ –∞–ª–∞—Å—ã–∑.', footerText: '–ë–∞—Ä–¥—ã–∫ —É–∫—É–∫—Ç–∞—Ä –∫–æ—Ä–≥–æ–ª–≥–æ–Ω.',
                    accountExists: '–ê–∫–∫–∞—É–Ω—Ç –±–∞—Ä, –∫–∏—Ä–∏“£–∏–∑.',
                    passwordMismatch: '–°—ã—Ä—Å”©–∑–¥”©—Ä –¥–∞–ª –∫–µ–ª–±–µ–π—Ç.',
                    passwordTooShort: '–°—ã—Ä—Å”©–∑ –∫–µ–º–∏–Ω–¥–µ 8 –±–µ–ª–≥–∏–¥–µ–Ω —Ç—É—Ä—É—à—É –∫–µ—Ä–µ–∫.',
                    passwordNoUppercase: '–°—ã—Ä—Å”©–∑ –∫–µ–º–∏–Ω–¥–µ –±–∏—Ä —á–æ“£ —Ç–∞–º–≥–∞–Ω—ã –∫–∞–º—Ç—ã—à—ã –∫–µ—Ä–µ–∫.',
                    passwordNoLowercase: '–°—ã—Ä—Å”©–∑ –∫–µ–º–∏–Ω–¥–µ –±–∏—Ä –∫–∏—á–∏–Ω–µ —Ç–∞–º–≥–∞–Ω—ã –∫–∞–º—Ç—ã—à—ã –∫–µ—Ä–µ–∫.',
                    passwordNoDigit: '–°—ã—Ä—Å”©–∑ –∫–µ–º–∏–Ω–¥–µ –±–∏—Ä —Å–∞–Ω–¥—ã –∫–∞–º—Ç—ã—à—ã –∫–µ—Ä–µ–∫.',
                    passwordNoSpecialChar: '–°—ã—Ä—Å”©–∑ –∫–µ–º–∏–Ω–¥–µ –±–∏—Ä –∞—Ç–∞–π—ã–Ω –±–µ–ª–≥–∏–Ω–∏ (!@#$%^&*) –∫–∞–º—Ç—ã—à—ã –∫–µ—Ä–µ–∫.',
                    repeatPassword: '–°—ã—Ä—Å”©–∑–¥“Ø –∫–∞–π—Ç–∞–ª–∞“£—ã–∑',
                    restaurantLoadError: '–†–µ—Å—Ç–æ—Ä–∞–Ω–¥–∞—Ä–¥—ã –∂“Ø–∫—Ç”©”©–¥”© –∫–∞—Ç–∞ –∫–µ—Ç—Ç–∏.',
                    menuLoadError: '–ú–µ–Ω—é–Ω—É –∂“Ø–∫—Ç”©”©–¥”© –∫–∞—Ç–∞ –∫–µ—Ç—Ç–∏.',
                    orderSuccess: '–°–∏–∑–¥–∏–Ω –±—É–π—Ä—É—Ç–º–∞“£—ã–∑ –∫–∞–±—ã–ª –∞–ª—ã–Ω–¥—ã!',
                    trackOrder: '–ë—É–π—Ä—É—Ç–º–∞–Ω—ã –∫”©–∑”©–º”©–ª–¥”©”©',
                    orderStatus: {
                        'pending': '–ö“Ø—Ç“Ø“Ø–¥”©',
                        'preparing': '–î–∞—è—Ä–¥–∞–ª—É—É–¥–∞',
                        'on_the_way': '–ñ–æ–ª–¥–æ',
                        'delivered': '–ñ–µ—Ç–∫–∏–∑–∏–ª–¥–∏'
                    },
                    orderCreationError: '–ë—É–π—Ä—É—Ç–º–∞ —Ç“Ø–∑“Ø“Ø–¥”© –∫–∞—Ç–∞ –∫–µ—Ç—Ç–∏!',
                    trackingError: '–ö”©–∑”©–º”©–ª–¥”©”©–¥”© –∫–∞—Ç–∞ –∫–µ—Ç—Ç–∏.',
                    profileLoadError: '–ü—Ä–æ—Ñ–∏–ª—å –º–∞–∞–ª—ã–º–∞—Ç—Ç–∞—Ä—ã–Ω –∂“Ø–∫—Ç”©”©–¥”© –∫–∞—Ç–∞ –∫–µ—Ç—Ç–∏.',
                    fullName: '–¢–æ–ª—É–∫ –∞—Ç—ã-–∂”©–Ω“Ø',
                    phoneNumber: '–¢–µ–ª–µ—Ñ–æ–Ω –Ω–æ–º–µ—Ä–∏',
                    address: '–î–∞—Ä–µ–∫',
                    cancelButton: '–ñ–æ–∫–∫–æ —á—ã–≥–∞—Ä—É—É',
                    saveButton: '–°–∞–∫—Ç–æ–æ',
                    profileUpdateSuccess: '–ü—Ä–æ—Ñ–∏–ª—å –∏–π–≥–∏–ª–∏–∫—Ç“Ø“Ø –∂–∞“£—ã—Ä—Ç—ã–ª–¥—ã!',
                    profileUpdateError: '–ü—Ä–æ—Ñ–∏–ª—å–¥–∏ –∂–∞“£—ã—Ä—Ç—É—É–¥–∞ –∫–∞—Ç–∞ –∫–µ—Ç—Ç–∏.',
                    selectOnMapButton: '–ö–∞—Ä—Ç–∞–¥–∞–Ω —Ç–∞–Ω–¥–æ–æ',
                    uploadPhoto: '–°“Ø—Ä”©—Ç –∂“Ø–∫—Ç”©”©'
                },
                'ru': {
                    appName: 'Karakol Delivery', homeTitle: '–°–∞–º—ã–µ –≤–∫—É—Å–Ω—ã–µ –±–ª—é–¥–∞ –≤ –æ–¥–∏–Ω –∫–ª–∏–∫!', homeSubtitle: '–ó–∞–∫–∞–∂–∏—Ç–µ –µ–¥—É –∏–∑ –≤–∞—à–µ–≥–æ –ª—é–±–∏–º–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞.', viewRestaurants: '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã',
                    restaurantsTitle: '–†–µ—Å—Ç–æ—Ä–∞–Ω—ã', menuTitle: '–ú–µ–Ω—é', addToCart: '–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É', orderPageTitle: '–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞', orderSummary: '–í–∞—à –∑–∞–∫–∞–∑:',
                    totalSum: '–ò—Ç–æ–≥–æ:', paymentType: '–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:', placeOrder: '–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –∑–∞–∫–∞–∑', trackingTitle: '–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞',
                    courierStatus: '–ö—É—Ä—å–µ—Ä –≤ –ø—É—Ç–∏...', profileTitle: '–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å', orderHistory: '–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤', restaurant: '–†–µ—Å—Ç–æ—Ä–∞–Ω', courier: '–ö—É—Ä—å–µ—Ä', status: '–°—Ç–∞—Ç—É—Å', backHome: '–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é',
                    emptyCart: '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã!', itemAdded: '–¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É',
                    loginTitle: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', loginSubtitle: '–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞', username: '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', password: '–ü–∞—Ä–æ–ª—å', loginButton: '–í–æ–π—Ç–∏',
                    invalidLogin: '–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å!', logout: '–í—ã–π—Ç–∏', loading: '–ó–∞–≥—Ä—É–∑–∫–∞...', homeButton: '–ì–ª–∞–≤–Ω–∞—è', cartButton: '–ö–æ—Ä–∑–∏–Ω–∞', profileButton: '–ü—Ä–æ—Ñ–∏–ª—å',
                    registerTitle: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è', registerButton: '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è',
                    registrationSuccess: '–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å! –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.', footerText: '–í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.',
                    accountExists: '–ê–∫–∫–∞—É–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ.',
                    passwordMismatch: 'Parollar ne sovpadayut.',
                    passwordTooShort: '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤.',
                    passwordNoUppercase: '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∑–∞–≥–ª–∞–≤–Ω—É—é –±—É–∫–≤—É.',
                    passwordNoLowercase: '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å—Ç—Ä–æ—á–Ω—É—é –±—É–∫–≤—É.',
                    passwordNoDigit: '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É.',
                    passwordNoSpecialChar: '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–∏–º–≤–æ–ª (!@#$%^&*).',
                    repeatPassword: '–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å',
                    restaurantLoadError: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤.',
                    menuLoadError: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ–Ω—é.',
                    orderSuccess: '–í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!',
                    trackOrder: '–û—Ç—Å–ª–µ–¥–∏—Ç—å –∑–∞–∫–∞–∑',
                    orderStatus: {
                        'pending': '–ü—Ä–∏–Ω—è—Ç–æ',
                        'preparing': '–ì–æ—Ç–æ–≤–∏—Ç—Å—è',
                        'on_the_way': '–í –ø—É—Ç–∏',
                        'delivered': '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ'
                    },
                    orderCreationError: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞!',
                    trackingError: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞.',
                    profileLoadError: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è.',
                    fullName: '–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è',
                    phoneNumber: '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞',
                    address: '–ê–¥—Ä–µ—Å',
                    cancelButton: '–û—Ç–º–µ–Ω–∞',
                    saveButton: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
                    profileUpdateSuccess: '–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!',
                    profileUpdateError: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è.',
                    selectOnMapButton: '–í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ',
                    uploadPhoto: '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ'
                },
                'en': {
                    appName: 'Karakol Delivery', homeTitle: 'The most delicious food in one click!', homeSubtitle: 'Order food from your favorite restaurant.', viewRestaurants: 'View Restaurants',
                    restaurantsTitle: 'Restaurants', menuTitle: 'Menu', addToCart: 'Add to Cart', orderPageTitle: 'Checkout', orderSummary: 'Your Order:',
                    totalSum: 'Total:', paymentType: 'Payment type:', placeOrder: 'Place Order', trackingTitle: 'Order Tracking',
                    courierStatus: 'Courier is on the way...', profileTitle: 'My Profile', orderHistory: 'Order History', restaurant: 'Restaurant', courier: 'Courier', status: 'Status', backHome: 'Back to Home',
                    emptyCart: 'Cart is empty, please select items first!', itemAdded: 'added to cart',
                    loginTitle: 'Welcome!', loginSubtitle: 'Enter your details to log in', username: 'Username', password: 'Password', loginButton: 'Log In',
                    invalidLogin: 'Invalid username or password!', logout: 'Log Out', loading: 'Loading...', homeButton: 'Home', cartButton: 'Cart', profileButton: 'Profile',
                    registerTitle: 'Registration', registerButton: 'Register',
                    registrationSuccess: 'You have successfully registered! You can log in now.', footerText: 'All rights reserved.',
                    accountExists: 'Account exists, please log in.',
                    passwordMismatch: 'Passwords do not match.',
                    passwordTooShort: 'Password must be at least 8 characters long.',
                    passwordNoUppercase: 'Password must contain at least one uppercase letter.',
                    passwordNoLowercase: 'Password must contain at least one lowercase letter.',
                    passwordNoDigit: 'Password must contain at least one digit.',
                    passwordNoSpecialChar: 'Password must contain at least one special character (!@#$%^&*).',
                    repeatPassword: 'Repeat password',
                    restaurantLoadError: 'Error loading restaurants.',
                    menuLoadError: 'Error loading menu.',
                    orderSuccess: 'Your order has been placed!',
                    trackOrder: 'Track Order',
                    orderStatus: {
                        'pending': 'Accepted',
                        'preparing': 'Preparing',
                        'on_the_way': 'On the way',
                        'delivered': 'Delivered'
                    },
                    orderCreationError: 'Error creating order!',
                    trackingError: 'Error tracking order.',
                    profileLoadError: 'Error loading profile.',
                    fullName: 'Full Name',
                    phoneNumber: 'Phone Number',
                    address: 'Address',
                    cancelButton: 'Cancel',
                    saveButton: 'Save',
                    profileUpdateSuccess: 'Profile updated successfully!',
                    profileUpdateError: 'Error updating profile.',
                    selectOnMapButton: 'Select on Map',
                    uploadPhoto: 'Upload Photo'
                }
            }
        };

        const DGIS_API_KEY = '91cf1308-c1e9-4caa-b7c8-9667c98e04ee'; // Replace with your actual 2GIS API Key

        // Global function to update selected location details and input fields
        async function updateSelectedLocation(lat, lng, addressText) {
            appState.selectedLatitude = lat;
            appState.selectedLongitude = lng;
            appState.selectedAddressText = addressText; // Store the address text

            getElement('profile-latitude').value = lat.toFixed(6);
            getElement('profile-longitude').value = lng.toFixed(6);
            getElement('profile-address').value = addressText; // Update the form input
        }

        // Yordamchi funksiyalar
        const getElement = (id) => document.getElementById(id);
        const getTranslation = (key) => appState.translations[appState.currentLang][key] || key;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
        const togglePasswordVisibility = (inputId, toggleButtonId) => {
            const passwordInput = getElement(inputId);
            const toggleButton = getElement(toggleButtonId);
            if (passwordInput && toggleButton) {
                const icon = toggleButton.querySelector('i');
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            }
        };

        // Sahifalar orasida navigatsiya
        const navigateTo = (page, data = null) => {
            appState.currentPage = page;
            appState.currentPageData = data;
            renderPage();
        };

        // UI elementlarini yangilash
        const updateUI = () => {
            document.querySelectorAll('.lang-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === appState.currentLang) {
                    btn.classList.add('active');
                }
            });
            getElement('cart-count').textContent = appState.cart.length;
            getElement('app-name-display').textContent = getTranslation('appName');
            getElement('home-btn').title = getTranslation('homeButton');
            getElement('cart-btn').title = getTranslation('cartButton');
            getElement('profile-btn').title = getTranslation('profileButton');
            document.querySelector('footer').innerHTML = `&copy; 2024 Karakol Delivery. ${getTranslation('footerText')}.`;

            const headerNav = getElement('header-nav');
            if (appState.token) {
                headerNav.style.display = 'flex';
            } else {
                headerNav.style.display = 'none';
            }
        };

        // Fetch API yordamida ma'lumotlarni olish
        const fetchData = async (endpoint, options = {}) => {
            // –£–¥–∞–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π 'api/' –∏–∑ endpoint, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, —Ç–∞–∫ –∫–∞–∫ apiBaseUrl —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç '/api/'
            const cleanEndpoint = endpoint.startsWith('api/') ? endpoint.substring(4) : endpoint;
            
            let targetUrl;
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç –∫ —Ä–æ—É—Ç–µ—Ä—É (ViewSets) –∏–ª–∏ –∫ –ø—Ä—è–º—ã–º –º–∞—Ä—à—Ä—É—Ç–∞–º (auth, profile)
            if (['categories/', 'products/', 'orders/', 'delivery-zones/', 'delivery-persons/', 'restaurants/', 
                 'delivery-tracking/', 'order-items/', 'ratings/', 'map/', 'payouts/', 'payments/', 
                 'device-tokens/'].some(prefix => cleanEndpoint.startsWith(prefix))) {
                targetUrl = `${appState.apiBaseUrl}endpoints/${cleanEndpoint}`;
            } else {
                targetUrl = `${appState.apiBaseUrl}${cleanEndpoint}`;
            }

            let headers = {
                ...options.headers,
            };

            // –ï—Å–ª–∏ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ - FormData, –±—Ä–∞—É–∑–µ—Ä —Å–∞–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç Content-Type
            // –ò–Ω–∞—á–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Content-Type: application/json
            if (!(options.body instanceof FormData)) {
                headers['Content-Type'] = 'application/json';
            }
            
            if (appState.token) {
                headers['Authorization'] = `Bearer ${appState.token}`;
                console.log('Token found, adding to headers:', appState.token);
            } else {
                console.log('No token found for request to:', targetUrl);
            }

            // –£–¥–∞–ª—è–µ–º Content-Type, –µ—Å–ª–∏ –æ–Ω undefined (–¥–ª—è FormData)
            if (headers['Content-Type'] === undefined) {
                delete headers['Content-Type'];
            }

            try {
                console.log('Sending request to:', targetUrl, 'with headers:', headers);
                const response = await fetch(targetUrl, { ...options, headers });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(JSON.stringify(errorData));
                }
                return await response.json();
            } catch (error) {
                console.error(`Fetch error for ${targetUrl}:`, error);
                throw error;
            }
        };

        // Sahifalarni render qilish funksiyalari
        const renderLoginPage = () => {
            const t = appState.translations[appState.currentLang];
            getElement('main-content').innerHTML = `
                <div class="bg-white rounded-xl shadow-lg p-8 max-w-sm mx-auto my-20">
                    <div class="text-center mb-6">
                        <i class="fa-solid fa-motorcycle text-primary text-4xl mb-2"></i>
                        <h2 class="text-3xl font-bold">${t.loginTitle}</h2>
                        <p class="text-gray-600 mb-4">${t.loginSubtitle}</p>
                    </div>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="username" class="block text-gray-700 font-medium mb-1">${t.username}</label>
                            <input type="text" id="username" name="username" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div class="mb-6 relative">
                            <label for="password" class="block text-gray-700 font-medium mb-1">${t.password}</label>
                            <input type="password" id="password" name="password" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary pr-10" required>
                            <button type="button" id="toggle-login-password" class="absolute inset-y-0 right-0 pr-3 flex items-center top-7 text-gray-400 hover:text-gray-600">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                        <button type="submit" class="w-full bg-primary text-white font-semibold py-3 rounded-full hover-bg-primary transition-colors">${t.loginButton}</button>
                    </form>
                    <p id="login-error-message" class="text-red-500 text-center mt-4 hidden">${t.invalidLogin}</p>
                    <p class="text-center mt-4 text-gray-600">
                        <a href="#" id="register-link" class="text-primary hover:underline">${t.registerButton}</a>
                    </p>
                </div>
            `;
            getElement('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = getElement('username').value;
                const password = getElement('password').value;
                const errorMessage = getElement('login-error-message');
                errorMessage.classList.add('hidden');
                
                try {
                    const data = await fetchData('token/', {
                        method: 'POST',
                        body: JSON.stringify({ username, password })
                    });
                    appState.token = data.access;
                    localStorage.setItem('authToken', data.access);
                    navigateTo('home');
                } catch (error) {
                    errorMessage.classList.remove('hidden');
                    console.error('Login error:', error);
                }
            });
            getElement('register-link').addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('register');
            });

            // –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è –≤ —Ñ–æ—Ä–º–µ –≤—Ö–æ–¥–∞
            getElement('toggle-login-password').addEventListener('click', () => togglePasswordVisibility('password', 'toggle-login-password'));
        };

        const renderRegisterPage = () => {
            const t = appState.translations[appState.currentLang];
            getElement('main-content').innerHTML = `
                <div class="bg-white rounded-xl shadow-lg p-8 max-w-sm mx-auto my-10">
                    <div class="text-center mb-6">
                        <i class="fa-solid fa-user-plus text-primary text-4xl mb-2"></i>
                        <h2 class="text-3xl font-bold">${t.registerTitle}</h2>
                    </div>
                    <form id="register-form">
                        <div class="mb-4">
                            <label for="reg-username" class="block text-gray-700 font-medium mb-1">${t.username}</label>
                            <input type="text" id="reg-username" name="username" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        <div class="mb-4 relative">
                            <label for="reg-password" class="block text-gray-700 font-medium mb-1">${t.password}</label>
                            <input type="password" id="reg-password" name="password" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary pr-10" required>
                            <button type="button" id="toggle-reg-password" class="absolute inset-y-0 right-0 pr-3 flex items-center top-7 text-gray-400 hover:text-gray-600">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                            <div id="password-requirements" class="text-sm mt-2 space-y-1">
                                <p id="req-length" class="text-gray-500"><i class="fa-solid fa-circle-xmark mr-1"></i> ${t.passwordTooShort}</p>
                                <p id="req-uppercase" class="text-gray-500"><i class="fa-solid fa-circle-xmark mr-1"></i> ${t.passwordNoUppercase}</p>
                                <p id="req-lowercase" class="text-gray-500"><i class="fa-solid fa-circle-xmark mr-1"></i> ${t.passwordNoLowercase}</p>
                                <p id="req-digit" class="text-gray-500"><i class="fa-solid fa-circle-xmark mr-1"></i> ${t.passwordNoDigit}</p>
                                <p id="req-special" class="text-gray-500"><i class="fa-solid fa-circle-xmark mr-1"></i> ${t.passwordNoSpecialChar}</p>
                            </div>
                        </div>
                        <div class="mb-6 relative">
                            <label for="reg-password-confirm" class="block text-gray-700 font-medium mb-1">${t.repeatPassword}</label>
                            <input type="password" id="reg-password-confirm" name="password2" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary pr-10" required>
                            <button type="button" id="toggle-reg-password-confirm" class="absolute inset-y-0 right-0 pr-3 flex items-center top-7 text-gray-400 hover:text-gray-600">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                        <button type="submit" class="w-full bg-primary text-white font-semibold py-3 rounded-full hover-bg-primary transition-colors">${t.registerButton}</button>
                    </form>
                    <p id="register-error-message" class="text-red-500 text-center mt-4 hidden"></p>
                    <p class="text-center mt-4 text-gray-600">
                        <a href="#" id="login-link" class="text-primary hover:underline">Kirish sahifasiga qaytish</a>
                    </p>
                </div>
            `;
            getElement('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = getElement('reg-username').value;
                const password = getElement('reg-password').value;
                const password2 = getElement('reg-password-confirm').value;
                const errorMessage = getElement('register-error-message');
                errorMessage.classList.add('hidden');

                if (password !== password2) {
                    errorMessage.textContent = t.passwordMismatch;
                    errorMessage.classList.remove('hidden');
                    return;
                }

                // Password validation rules
                if (password.length < 8) {
                    errorMessage.textContent = t.passwordTooShort;
                    errorMessage.classList.remove('hidden');
                    return;
                }
                if (!/[A-Z]/.test(password)) {
                    errorMessage.textContent = t.passwordNoUppercase;
                    errorMessage.classList.remove('hidden');
                    return;
                }
                if (!/[a-z]/.test(password)) {
                    errorMessage.textContent = t.passwordNoLowercase;
                    errorMessage.classList.remove('hidden');
                    return;
                }
                if (!/[0-9]/.test(password)) {
                    errorMessage.textContent = t.passwordNoDigit;
                    errorMessage.classList.remove('hidden');
                    return;
                }
                if (!/[!@#$%^&*]/.test(password)) {
                    errorMessage.textContent = t.passwordNoSpecialChar;
                    errorMessage.classList.remove('hidden');
                    return;
                }

                try {
                    const data = await fetchData('register/', {
                        method: 'POST',
                        body: JSON.stringify({ username, password, password2 })
                    });
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                    appState.token = data.access; // –°–æ—Ö—Ä–∞–Ω—è–µ–º access token
                    localStorage.setItem('authToken', data.access);
                    alert(t.registrationSuccess);
                    navigateTo('home'); // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –¥–æ–º–∞—à–Ω—é—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                } catch (error) {
                    const errorObj = JSON.parse(error.message);
                    if (errorObj.username && errorObj.username.includes('already exists')) {
                        errorMessage.textContent = t.accountExists;
                    } else if (errorObj.password) {
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–∞—Ä–æ–ª—è –æ—Ç –±—ç–∫–µ–Ω–¥–∞
                        errorMessage.textContent = errorObj.password.join(' '); // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –ø–∞—Ä–æ–ª—è
                    } else {
                        errorMessage.textContent = 'Ro‚Äòyxatdan o‚Äòtishda xato yuz berdi.'; // –û–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                    }
                    errorMessage.classList.remove('hidden');
                    console.error('Registration error:', error);
                }
            });
            getElement('login-link').addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('login');
            });

            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è –ø—Ä–∏ –≤–≤–æ–¥–µ
            const passwordInput = getElement('reg-password');
            const passwordConfirmInput = getElement('reg-password-confirm');
            const passwordRequirementsDiv = getElement('password-requirements');
            const reqLength = getElement('req-length');
            const reqUppercase = getElement('req-uppercase');
            const reqLowercase = getElement('req-lowercase');
            const reqDigit = getElement('req-digit');
            const reqSpecial = getElement('req-special');

            const updatePasswordRequirements = () => {
                const password = passwordInput.value;
                const check = (regex, reqElement, translationKey) => {
                    if (regex.test(password)) {
                        reqElement.classList.remove('text-gray-500', 'text-red-500');
                        reqElement.classList.add('text-green-600');
                        reqElement.querySelector('i').classList.remove('fa-circle-xmark');
                        reqElement.querySelector('i').classList.add('fa-circle-check');
                    } else {
                        reqElement.classList.remove('text-green-600');
                        reqElement.classList.add('text-gray-500'); // –°–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–Ω—ã–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —è–≤–Ω–æ–π –æ—à–∏–±–∫–µ
                        reqElement.querySelector('i').classList.remove('fa-circle-check');
                        reqElement.querySelector('i').classList.add('fa-circle-xmark');
                    }
                };

                check(/.{8,}/, reqLength, 'passwordTooShort');
                check(/[A-Z]/, reqUppercase, 'passwordNoUppercase');
                check(/[a-z]/, reqLowercase, 'passwordNoLowercase');
                check(/[0-9]/, reqDigit, 'passwordNoDigit');
                check(/[!@#$%^&*]/, reqSpecial, 'passwordNoSpecialChar');
            };

            passwordInput.addEventListener('input', updatePasswordRequirements);
            updatePasswordRequirements(); // Initial check on page load

            // –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
            getElement('toggle-reg-password').addEventListener('click', () => togglePasswordVisibility('reg-password', 'toggle-reg-password'));
            getElement('toggle-reg-password-confirm').addEventListener('click', () => togglePasswordVisibility('reg-password-confirm', 'toggle-reg-password-confirm'));
        };

        const renderHomePage = () => {
            const t = appState.translations[appState.currentLang];
            getElement('main-content').innerHTML = `
                <div class="text-center py-20 px-4">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 leading-tight mb-4">${t.homeTitle}</h1>
                    <p class="text-lg md:text-xl text-gray-600 mb-8">${t.homeSubtitle}</p>
                    <button id="view-restaurants-btn" class="bg-primary text-white font-semibold py-3 px-8 rounded-full shadow-lg hover-bg-primary transition-colors text-lg">
                        ${t.viewRestaurants}
                    </button>
                </div>
            `;
            getElement('view-restaurants-btn').addEventListener('click', () => navigateTo('restaurants'));
        };

        const renderRestaurantsPage = async () => {
            const t = appState.translations[appState.currentLang];
            const mainContent = getElement('main-content');
            mainContent.innerHTML = `<p class="text-center text-xl text-gray-500 mt-20">${t.loading}</p>`;

            try {
                const restaurantsData = await fetchData('restaurants/');
                console.log('Fetched restaurants data:', restaurantsData); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
                const restaurants = restaurantsData.results; // –ò–∑–≤–ª–µ–∫–∞–µ–º –º–∞—Å—Å–∏–≤ –∏–∑ –ø–æ–ª—è 'results'
                appState.cachedData.restaurants = restaurants;
                const restaurantListHtml = restaurants.map(rest => `
                    <div class="bg-white rounded-xl shadow-md p-4 cursor-pointer hover:shadow-xl transition-shadow" onclick="navigateTo('menu', {id: ${rest.id}, name: '${rest.name}'})">
                        <img src="https://placehold.co/400x250/fce7f3/ec4899?text=${rest.name}" alt="${rest.name}" class="rounded-lg w-full h-40 object-cover mb-4">
                        <h3 class="text-xl font-semibold">${rest.name}</h3>
                    </div>
                `).join('');
                
                mainContent.innerHTML = `
      <h2 class="text-3xl font-bold mb-6 text-center">${t.restaurantsTitle}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${restaurantListHtml}</div>
                `;
            } catch (error) {
                mainContent.innerHTML = `<p class="text-center text-red-500 mt-20">${getTranslation('restaurantLoadError')}</p>`;
            }
        };

        const renderMenuPage = async (data) => {
            const t = appState.translations[appState.currentLang];
            const mainContent = getElement('main-content');
            mainContent.innerHTML = `<p class="text-center text-xl text-gray-500 mt-20">${t.loading}</p>`;
            
            try {
                const menuData = await fetchData(`products/?restaurant=${data.id}`);
                console.log('Fetched menu data:', menuData); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
                const menu = menuData.results; // –ò–∑–≤–ª–µ–∫–∞–µ–º –º–∞—Å—Å–∏–≤ –∏–∑ –ø–æ–ª—è 'results'
                appState.cachedData.products = menu;
                const menuHtml = menu.map(item => `
                    <div class="bg-white rounded-xl shadow-md p-4 flex flex-col items-center text-center">
                        <h4 class="text-lg font-semibold">${item.name}</h4>
                        <p class="text-gray-600 mb-2">${item.description || ''}</p>
                        <p class="text-green-600 font-bold text-xl">${item.price.toLocaleString()} ${appState.currentCurrency}</p>
                        <button class="add-to-cart-btn mt-4 w-full bg-orange-500 text-white rounded-full py-2 hover:bg-orange-600 transition-colors" data-item-id="${item.id}">${t.addToCart}</button>
                    </div>
                `).join('');

                mainContent.innerHTML = `
                    <h2 class="text-3xl font-bold mb-6 text-center">${data.name} ${t.menuTitle}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${menuHtml}</div>
                `;

                document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const itemId = parseInt(e.target.dataset.itemId);
                        const item = appState.cachedData.products.find(m => m.id === itemId);
                        if (item) {
                            appState.cart.push(item);
                            alert(`${item.name} ${t.itemAdded}!`);
                            updateUI();
                        }
                    });
                });
            } catch (error) {
                mainContent.innerHTML = `<p class="text-center text-red-500 mt-20">${getTranslation('menuLoadError')}</p>`;
            }
        };

        const renderOrderPage = () => {
            const t = appState.translations[appState.currentLang];
            if (appState.cart.length === 0) {
                alert(t.emptyCart);
                navigateTo('restaurants');
                return;
            }
            const total = appState.cart.reduce((sum, item) => sum + item.price, 0);
            const cartHtml = appState.cart.map(item => `
                <div class="flex justify-between py-2 border-b border-gray-100">
                    <span>${item.name}</span>
                    <span>${item.price.toLocaleString()} ${appState.currentCurrency}</span>
                </div>
            `).join('');

            getElement('main-content').innerHTML = `
                <div class="bg-white rounded-xl shadow-md p-6 max-w-md mx-auto">
                    <h2 class="text-3xl font-bold mb-6 text-center">${t.orderPageTitle}</h2>
                    <h3 class="text-xl font-semibold mb-2">${t.orderSummary}</h3>
                    ${cartHtml}
                    <div class="text-2xl font-bold flex justify-between py-4 border-t-2 border-gray-200 mt-4">
                        <span>${t.totalSum}</span>
                        <span class="text-green-600">${total.toLocaleString()} ${appState.currentCurrency}</span>
                    </div>
                    <label for="payment-type" class="block text-gray-700 font-medium mt-6 mb-2">${t.paymentType}</label>
                    <select id="payment-type" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="cash">Naqd pul / –ù–∞–ª–∏—á–Ω—ã–µ / Cash</option>
                        <option value="card">Bank kartasi / –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞ / Credit card</option>
                    </select>
                    <button id="place-order-btn" class="w-full bg-primary text-white rounded-full py-3 mt-8 font-semibold hover-bg-primary transition-colors">${t.placeOrder}</button>
            </div>
            `;
            getElement('place-order-btn').addEventListener('click', async () => {
                const orderItems = appState.cart.map(item => ({ product: item.id, quantity: 1 }));
                try {
                    const orderData = await fetchData('orders/', {
                        method: 'POST',
                        body: JSON.stringify({
                            items: orderItems,
                        })
                    });
                    alert(t.orderSuccess);
                    appState.cart = [];
                    appState.cachedData.orders.push(orderData); // Buyurtmani keshga qo'shish
                    updateUI();
                    navigateTo('tracking', { orderId: orderData.id });
                } catch (error) {
                    alert(t.orderCreationError); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    console.error('Order creation error:', error);
                }
            });
        };

        const renderTrackingPage = async (data) => {
            const t = appState.translations[appState.currentLang];
            const mainContent = getElement('main-content');
            mainContent.innerHTML = `<p class="text-center text-xl text-gray-500 mt-20">${t.loading}</p>`;
            
            // Simulyatsiya: API'dan real vaqtda yangilash
            const trackOrder = async () => {
                try {
                    const order = await fetchData(`orders/${data.orderId}/`);
                    
                    const statusText = t.orderStatus[order.status] || order.status;
                    mainContent.innerHTML = `
                        <div class="bg-white rounded-xl shadow-md p-6 text-center max-w-md mx-auto">
                            <h2 class="text-3xl font-bold mb-4">${t.trackingTitle}</h2>
                            <p class="text-lg text-gray-600 mb-2">Buyurtma ‚Ññ${order.id}</p>
                            <p class="text-2xl font-semibold mb-6 text-primary">${statusText}</p>
                            <div class="w-full h-60 bg-gray-200 rounded-lg relative overflow-hidden flex items-center justify-center">
                                <i class="fa-solid fa-motorcycle text-4xl text-primary animate-pulse"></i>
                            </div>
                            <button onclick="navigateTo('home')" class="w-full bg-gray-500 text-white rounded-full py-3 mt-8 font-semibold hover:bg-gray-600 transition-colors">${t.backHome}</button>
            </div>
                    `;
                  
    
                    if (order.status !== 'delivered') {
                        setTimeout(trackOrder, 5000);
                    }
                } catch (error) {
                    mainContent.innerHTML = `<p class="text-center text-red-500 mt-20">${getTranslation('trackingError')}</p>`;
                    console.error('Tracking error:', error);
                }
            };

            trackOrder();
        };

        const renderProfilePage = async () => {
            const t = appState.translations[appState.currentLang];
            const mainContent = getElement('main-content');

            try {
                const profileData = await fetchData('user-profile/', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${appState.token}`,
                    },
                });

                const user = profileData || {};
                let profile = user.profile || {};
                let username = user.username || '';
                let first_name = user.first_name || '';
                let last_name = user.last_name || '';
                let phoneNumber = profile.phone_number || '';
                let address = profile.address || '';

                // Initialize appState with existing profile coordinates and address
                appState.selectedLatitude = profile.latitude || null;
                appState.selectedLongitude = profile.longitude || null;
                appState.selectedAddressText = address; // Set initial address text

                // Fetch orders for order history
                let orders = [];
                try {
                    const ordersData = await fetchData('orders/', {
                        headers: {
                            'Authorization': `Bearer ${appState.token}`,
                        },
                    });
                    orders = ordersData.results || [];
                    appState.cachedData.orders = orders; // Cache orders
                } catch (orderError) {
                    console.error('Error fetching orders for profile:', orderError);
                }

                const orderHistoryHtml = orders.length > 0
                    ? orders.map(order => `
                        <div class="bg-gray-50 p-4 rounded-lg shadow-sm mb-3">
                            <p class="font-semibold">${t.restaurant}: ${order.restaurant_info ? order.restaurant_info.name : 'N/A'}</p>
                            <p>${t.status}: ${t.orderStatus[order.status] || order.status}</p>
                            <p>${t.totalSum}: ${order.total_amount.toLocaleString()} ${appState.currentCurrency}</p>
                            <button onclick="navigateTo('tracking', { orderId: ${order.id} })" class="text-primary hover:underline mt-2">${t.trackOrder}</button>
                        </div>
                    `).join('')
                    : `<p>${t.noOrdersYet}</p>`;

            mainContent.innerHTML = `
                <div class="bg-white rounded-xl shadow-md p-6 max-w-xl mx-auto">

                <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold">${t.profileTitle}</h2>
                        <button id="logout-btn" class="text-sm text-gray-500 hover:text-red-500 transition-colors">${t.logout}</button>
            </div>
            
                        <div class="text-center mb-6">
                            <div class="w-24 h-24 bg-pink-200 rounded-full flex items-center justify-center text-5xl text-primary mx-auto mb-2 relative overflow-hidden">
                                <img id="profile-picture-preview" src="${profile && profile.profile_picture ? profile.profile_picture : 'https://placehold.co/96x96/fce7f3/ec4899?text=üë§'}" alt="Profile Picture" class="w-full h-full object-cover">
                                <label for="profile-picture-upload" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white text-xs opacity-0 hover:opacity-100 transition-opacity cursor-pointer">
                                    ${t.uploadPhoto || '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ'}
                                </label>
                                <input type="file" id="profile-picture-upload" accept="image/*" class="hidden">
                            </div>
                            <p class="text-xl font-bold">${phoneNumber || username}</p>
                            <p class="text-gray-600">${first_name || ''} ${last_name || ''}</p>
            </div>
            
                        <form id="profile-form">
                            <div class="mb-4">
                                <label for="profile-fullname" class="block text-gray-700 font-medium mb-1">${t.fullName}</label>
                                <input type="text" id="profile-fullname" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary" value="${first_name || ''} ${last_name || ''}">
                            </div>
                            <div class="mb-4">
                                <label for="profile-phone" class="block text-gray-700 font-medium mb-1">${t.phoneNumber}</label>
                                <div class="flex">
                                    <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">+996</span>
                                    <input type="text" id="profile-phone" class="flex-1 p-3 rounded-r-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary" value="${phoneNumber.startsWith('+996') ? phoneNumber.substring(4) : phoneNumber}">
                                </div>
                            </div>
                            <div class="mb-6">
                                <label for="profile-address" class="block text-gray-700 font-medium mb-1">${t.address}</label>
                                <div class="relative">
                                    <input type="text" id="profile-address" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary" value="${appState.selectedAddressText}">
                                    <div id="address-autocomplete-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden">
                                        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>
                                <input type="hidden" id="profile-latitude" value="${appState.selectedLatitude || ''}">
                                <input type="hidden" id="profile-longitude" value="${appState.selectedLongitude || ''}">
        </div>
                            </div>

                            <div class="flex justify-end space-x-4 mb-6">
                                <button type="button" id="cancel-profile-btn" class="bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-full hover:bg-gray-300 transition-colors">${t.cancelButton}</button>
                                <button type="submit" id="save-profile-btn" class="bg-primary text-white font-semibold py-3 px-6 rounded-full hover-bg-primary transition-colors">${t.saveButton}</button>
                            </div>
                        </form>

                        <h3 class="text-xl font-semibold mb-4">${t.orderHistory}</h3>
                        <div>${orderHistoryHtml}</div>
        </div>
                `;

                const phoneInput = getElement('profile-phone');
                if (phoneInput) {
                    phoneInput.addEventListener('input', (e) => {
                        let value = e.target.value.replace(/\D/g, ''); // –£–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
                        let formattedValue = '';

                        if (value.length > 0) {
                            formattedValue += '(' + value.substring(0, 3);
                        }
                        if (value.length > 3) {
                            formattedValue += ') ' + value.substring(3, 6);
                        }
                        if (value.length > 6) {
                            formattedValue += '-' + value.substring(6, 9);
                        }
                        e.target.value = formattedValue;
                    });

                    // –ù–∞—á–∞–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
                    let initialValue = phoneInput.value.replace(/\D/g, ''); // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
                    let formattedInitialValue = '';
                    if (initialValue.length > 0) {
                        formattedInitialValue += '(' + initialValue.substring(0, 3);
                    }
                    if (initialValue.length > 3) {
                        formattedInitialValue += ') ' + initialValue.substring(3, 6);
                    }
                    if (initialValue.length > 6) {
                        formattedInitialValue += '-' + initialValue.substring(6, 9);
                    }
                    phoneInput.value = formattedInitialValue;
                }

                const addressInput = getElement('profile-address');
                const autocompleteResultsDiv = getElement('address-autocomplete-results');
                let searchTimeout;

                addressInput.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    const query = addressInput.value.trim();

                    // Clear coordinates if user manually edits address after selection
                    appState.selectedLatitude = null;
                    appState.selectedLongitude = null;
                    getElement('profile-latitude').value = '';
                    getElement('profile-longitude').value = '';

                    if (query.length > 2) {
                        searchTimeout = setTimeout(async () => {
                            try {
                                const response = await fetch(`https://catalog.api.2gis.com/3.0/search?q=${query}&type=address&key=${DGIS_API_KEY}&fields=items.point,items.full_address`);
                                const data = await response.json();
                                console.log('2GIS Autocomplete Response:', data);
                                if (data.result && data.result.items && data.result.items.length > 0) {
                                    autocompleteResultsDiv.innerHTML = data.result.items.map(item => `
                                        <div class="p-3 hover:bg-gray-100 cursor-pointer text-gray-800"
                                             data-lat="${item.point.lat}"
                                             data-lng="${item.point.lon}"
                                             data-address="${item.full_address}">
                                            ${item.full_address}
                                        </div>
                                    `).join('');
                                    autocompleteResultsDiv.classList.remove('hidden');
                            } else {
                                    autocompleteResultsDiv.innerHTML = '';
                                    autocompleteResultsDiv.classList.add('hidden');
                            }
                            } catch (error) {
                                console.error('Error during address search:', error);
                                autocompleteResultsDiv.innerHTML = '';
                                autocompleteResultsDiv.classList.add('hidden');
                        }
                        }, 500);
                    } else {
                        autocompleteResultsDiv.innerHTML = '';
                        autocompleteResultsDiv.classList.add('hidden');
                    }
                });

                // Close autocomplete results when clicking outside
                document.addEventListener('click', (event) => {
                    if (!addressInput.contains(event.target) && !autocompleteResultsDiv.contains(event.target)) {
                        autocompleteResultsDiv.classList.add('hidden');
                    }
                });

                autocompleteResultsDiv.addEventListener('click', (event) => {
                    const selectedItem = event.target.closest('div[data-lat]');
                    if (selectedItem) {
                        const lat = parseFloat(selectedItem.dataset.lat);
                        const lng = parseFloat(selectedItem.dataset.lng);
                        const addressText = selectedItem.dataset.address;

                        updateSelectedLocation(lat, lng, addressText); // Update input fields with selected data
                        autocompleteResultsDiv.classList.add('hidden'); // Hide autocomplete list
                        console.log('Selected address:', addressText, 'Lat:', lat, 'Lng:', lng);
                    }
                });

                getElement('logout-btn').addEventListener('click', () => {
                    appState.token = null;
                    localStorage.removeItem('authToken');
                    navigateTo('login');
                });

                getElement('profile-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const fullName = getElement('profile-fullname').value.trim();
                    let phone = getElement('profile-phone').value.trim();
                    const newAddress = getElement('profile-address').value.trim();

                    console.log('Submitting profile form. Address:', newAddress, 'Lat:', appState.selectedLatitude, 'Lng:', appState.selectedLongitude);

                    if (phone && !phone.startsWith('+996')) {
                        phone = '+996' + phone;
                    } else if (phone === '+996') {
                        phone = '';
                    }

                    let firstName = '';
                    let lastName = '';
                    const nameParts = fullName.split(' ');
                    if (nameParts.length > 0) {
                        firstName = nameParts[0];
                        lastName = nameParts.slice(1).join(' ');
                    }

                    const formData = new FormData();
                    formData.append('first_name', firstName);
                    formData.append('last_name', lastName);
                    formData.append('profile.phone_number', phone);
                    formData.append('profile.address', newAddress);
                    formData.append('profile.latitude', appState.selectedLatitude || '');
                    formData.append('profile.longitude', appState.selectedLongitude || '');

                    const profilePictureFile = getElement('profile-picture-upload').files[0];
                    if (profilePictureFile) {
                        formData.append('profile.profile_picture', profilePictureFile);
                    }

                    try {
                        await fetchData('user-profile/', {
                            method: 'PATCH',
                            body: formData,
                            headers: {
                                'Authorization': `Bearer ${appState.token}`,
                            }
                        });
                        alert(t.profileUpdateSuccess);
                        navigateTo('profile');
                    } catch (error) {
                        alert(t.profileUpdateError);
                        console.error('Profile update error:', error);
                    }
                });

                getElement('cancel-profile-btn').addEventListener('click', () => {
                    navigateTo('profile');
                });

                getElement('profile-picture-upload').addEventListener('change', (event) => {
                    const [file] = event.target.files;
                    if (file) {
                        getElement('profile-picture-preview').src = URL.createObjectURL(file);
                    }
                });

            } catch (error) {
                mainContent.innerHTML = `<p class="text-center text-red-500 mt-20">${getTranslation('profileLoadError')}</p>`;
                console.error('Profile fetch error:', error);
            }
        };

        const renderPage = () => {
            if (appState.token && appState.currentPage === 'login') {
                appState.currentPage = 'home';
            } else if (!appState.token && appState.currentPage !== 'register') {
                appState.currentPage = 'login';
            }

            switch (appState.currentPage) {
                case 'login':
                    renderLoginPage();
                    break;
                case 'register':
                    renderRegisterPage();
                    break;
                case 'home':
                    renderHomePage();
                    break;
                case 'restaurants':
                    renderRestaurantsPage();
                    break;
                case 'menu':
                    renderMenuPage(appState.currentPageData);
                    break;
                case 'order':
                    renderOrderPage();
                    break;
                case 'tracking':
                    renderTrackingPage(appState.currentPageData);
                    break;
                case 'profile':
                    renderProfilePage();
                    break;
                default:
                    renderHomePage();
            }
            updateUI();
        };

        window.onload = () => {
            const storedToken = localStorage.getItem('authToken');
            console.log('window.onload: –ó–∞–≥—Ä—É–∂–µ–Ω —Ç–æ–∫–µ–Ω –∏–∑ localStorage:', storedToken); // Debugging log
            if (storedToken) {
                appState.token = storedToken;
                navigateTo('home');
            } else {
                navigateTo('login');
            }

            document.querySelectorAll('.lang-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    appState.currentLang = btn.dataset.lang;
                    appState.currentCurrency = (appState.currentLang === 'kg' ? 'KGS' : (appState.currentLang === 'ru' ? 'RUB' : 'USD'));
                    renderPage();
                });
            });

            document.getElementById('home-btn').addEventListener('click', () => navigateTo('home'));
            document.getElementById('cart-btn').addEventListener('click', () => navigateTo('order'));
            document.getElementById('profile-btn').addEventListener('click', () => navigateTo('profile'));
        };
    </script>

    <!-- Header va navigatsiya paneli -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container flex justify-between items-center py-4">
            <div class="flex items-center space-x-2">
                <i class="fa-solid fa-motorcycle text-primary text-2xl"></i>
                <span class="text-2xl font-bold text-gray-900" id="app-name-display">Karakol Delivery</span>
            </div>
            <nav id="header-nav" class="flex items-center space-x-4" style="display: none;">
                <button id="home-btn" class="text-gray-600 hover:text-primary transition-colors" title="${getTranslation('homeButton')}"><i class="fa-solid fa-home text-xl"></i></button>
                <button id="cart-btn" class="relative text-gray-600 hover:text-primary transition-colors" title="${getTranslation('cartButton')}">
                    <i class="fa-solid fa-shopping-cart text-xl"></i>
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center">0</span>
                </button>
                <button id="profile-btn" class="text-gray-600 hover:text-primary transition-colors" title="${getTranslation('profileButton')}"><i class="fa-solid fa-user text-xl"></i></button>
            </nav>
        </div>
        <div class="flex justify-center py-2 bg-gray-100 border-t">
            <button class="lang-button text-sm px-4 py-1 rounded-full mx-1 transition-colors" data-lang="kg">–ö—ã—Ä–≥—ã–∑—á–∞</button>
            <button class="lang-button text-sm px-4 py-1 rounded-full mx-1 transition-colors" data-lang="ru">–†—É—Å—Å–∫–∏–π</button>
            <button class="lang-button text-sm px-4 py-1 rounded-full mx-1 transition-colors" data-lang="en">English</button>
    </div>
    </header>

    <!-- Asosiy kontent render qilinadigan joy -->
    <main id="main-content" class="container py-8 flex-grow"></main>

    <footer class="text-center py-4 text-gray-500 text-sm">
        &copy; 2025 Karakol Delivery. ${getTranslation('footerText')}.
    </footer>

</body>
</html> 